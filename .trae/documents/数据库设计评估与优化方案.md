# 智能体服务平台数据库设计评估与优化方案

## 1. 评估概述

本文档基于《智能体服务平台需求规格说明书》和《功能模块划分文档》，对当前数据库设计进行全面评估，重点分析数据库结构与六层业务架构的匹配度，并提供具体的优化建议。

**评估原则**：

* 智能体对话和数据处理调用外部接口，数据库仅负责增删改查

* 遵循MVP原则，专注核心业务功能支持

* 确保数据库设计支持所有页面功能和业务逻辑

## 2. 差异分析

### 2.1 业务架构覆盖度分析

| 业务层级       | 当前数据库支持                                           | 覆盖度 | 缺失功能       |
| ---------- | ------------------------------------------------- | --- | ---------- |
| **门户展示层**  | ✅ portal\_contents                                | 80% | 缺少页面布局配置表  |
| **用户服务层**  | ✅ users, user\_roles, user\_subscriptions, orders | 95% | 基本完整       |
| **智能体服务层** | ✅ api\_keys, user\_mcp\_configs, providers        | 70% | 缺少智能体实例管理表 |
| **数据管理层**  | ✅ datasets, dataset\_processing\_logs             | 90% | 基本完整       |
| **系统管理层**  | ✅ event\_logs, api\_call\_logs                    | 60% | 缺少系统配置和监控表 |

### 2.2 页面功能支持分析

#### 2.2.1 ✅ 已充分支持的功能

* **用户认证与管理**：users, user\_roles, user\_user\_roles

* **订阅服务**：subscription\_plans, user\_subscriptions, orders

* **API管理**：api\_keys, api\_call\_logs

* **数据集管理**：datasets, dataset\_processing\_logs

* **供应商管理**：providers, provider\_configs

#### 2.2.2 ⚠️ 部分支持的功能

* **门户内容管理**：有portal\_contents但缺少布局配置

* **智能体配置**：有user\_mcp\_configs但缺少智能体实例管理

* **系统监控**：有基础日志但缺少系统配置管理

### 2.3 数据关系完整性分析

#### 2.3.1 ✅ 良好的关系设计

```sql
-- 用户-角色多对多关系
users ←→ user_user_roles ←→ user_roles

-- 用户订阅关系
users ←→ user_subscriptions ←→ subscription_plans

-- API调用链路
users ←→ api_keys ←→ api_call_logs

-- 数据集处理链路
users ←→ datasets ←→ dataset_processing_logs
```

#### 2.3.2 ⚠️ 需要优化的关系

* **智能体配置与数据集关联**：缺少智能体实例与数据集的绑定关系

* **MCP模型与智能体实例**：缺少模型配置与具体智能体实例的关联

* **用户权限细化**：当前角色权限过于粗粒度

## 3. 改进方案

### 3.1 新增必要表结构

#### 3.1.1 智能体实例管理表 (agent\_instances)

```sql
CREATE TABLE `agent_instances` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT '物理主键',
  `agent_id` VARCHAR(36) NOT NULL COMMENT '业务主键，UUID',
  `user_id` VARCHAR(36) NOT NULL COMMENT '用户业务主键',
  `name` VARCHAR(255) NOT NULL COMMENT '智能体名称',
  `description` TEXT DEFAULT NULL COMMENT '智能体描述',
  `mcp_config_id` VARCHAR(36) DEFAULT NULL COMMENT 'MCP配置业务主键',
  `dataset_id` VARCHAR(36) DEFAULT NULL COMMENT '绑定的数据集业务主键',
  `memory_enabled` BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否启用记忆功能',
  `status` VARCHAR(50) NOT NULL DEFAULT 'active' COMMENT '状态：active, inactive',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `ext_info` JSON DEFAULT NULL COMMENT '扩展字段',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_agent_id` (`agent_id`),
  KEY `fk_agent_instances_user_id` (`user_id`),
  KEY `fk_agent_instances_mcp_config_id` (`mcp_config_id`),
  KEY `fk_agent_instances_dataset_id` (`dataset_id`),
  CONSTRAINT `fk_agent_instances_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`user_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_agent_instances_mcp_config_id` FOREIGN KEY (`mcp_config_id`) REFERENCES `user_mcp_configs` (`user_mcp_config_id`) ON DELETE SET NULL,
  CONSTRAINT `fk_agent_instances_dataset_id` FOREIGN KEY (`dataset_id`) REFERENCES `datasets` (`dataset_id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='智能体实例表';
```

####

### 3.4 数据关系修正方案

#### 3.4.1 智能体服务层关系完善

```sql
-- 修正user_mcp_configs表，添加与智能体实例的关联
ALTER TABLE `user_mcp_configs`
ADD COLUMN `agent_id` VARCHAR(36) DEFAULT NULL COMMENT '关联的智能体实例ID',
ADD KEY `fk_user_mcp_configs_agent_id` (`agent_id`),
ADD CONSTRAINT `fk_user_mcp_configs_agent_id` FOREIGN KEY (`agent_id`) REFERENCES `agent_instances` (`agent_id`) ON DELETE SET NULL;
```

#### 3.4.2 API调用与智能体关联

```sql
-- 为api_call_logs表添加智能体实例关联
ALTER TABLE `api_call_logs`
ADD COLUMN `agent_id` VARCHAR(36) DEFAULT NULL COMMENT '调用的智能体实例ID',
ADD KEY `fk_api_call_logs_agent_id` (`agent_id`),
ADD CONSTRAINT `fk_api_call_logs_agent_id` FOREIGN KEY (`agent_id`) REFERENCES `agent_instances` (`agent_id`) ON DELETE SET NULL;
```

###
